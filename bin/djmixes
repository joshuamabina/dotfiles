#!/usr/bin/env bash

# TODO: Loop current playing track

# All djmixes
MIXDIR="$HOME/DjMixes"

RATE="1.999999"
ARTIST=""
PID_FILE="/tmp/cvlc.pid"

while [[ "$#" -gt 0 ]]; do
  case "$1" in
    --rate=*)
      RATE="${1#*=}"
      ;;
    --artist)
      shift
      ARTIST="$1"
      ;;
    *)
      echo "Unknown option: $1"
      ;;
  esac
  shift
done

#TODO: djmixes --list-artists
#TODO: djmixes --artist name gives error: No mixes found for artist
if [[ -n "$ARTIST" ]]; then
  FILELIST=$(find "$MIXDIR" -type f -iname "*$ARTIST*" | sort)
  if [[ -z "$FILELIST" ]]; then
    echo "No mixes found for artist: $ARTIST"
    exit 1
  fi
else
  FILELIST="$MIXDIR"
fi

# Check if the PID file exists and kill the process if it does
if [ -f "$PID_FILE" ]; then
  if ps -p $(cat "$PID_FILE") > /dev/null; then
    echo "Shuffling..."
    kill $(cat "$PID_FILE")
  fi
  rm "$PID_FILE"
fi

# Run cvlc to shuffle and play the playlist
# nohup allows the command to run in the background even if the terminal is closed
# --no-video disables video playback
# --random shuffles the playlist
# --rate=1.99999 adjusts playback speed slightly (you can adjust this or remove it if not needed)
nohup cvlc --no-video --random --rate="$RATE" "$FILELIST" > /tmp/nohup.djmixes.out 2>&1 &

# Save the PID of the new cvlc process
echo $! > "$PID_FILE"
